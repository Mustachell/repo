{% extends "./base.html" %}

{% block head %}
<!-- Añadir Leaflet CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}

{% block title %}Datos de {{ nombre_tabla }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h2 class="mb-0">{{ nombre_tabla }}</h2>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Listado de Datos</h1>
            <div class="btn-group">
                <button id="downloadVisibleButton" class="btn btn-sm btn-primary">Descargar Visible</button>
                <button id="downloadAllButton" class="btn btn-sm btn-secondary">Descargar Todo</button>
            </div>
        </div>
    </div>

    <div class="card-body">
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% else %}
            {% if datos %}
                <div class="table-responsive">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <span class="me-2">Mostrar</span>
                            <select class="form-select form-select-sm w-auto" id="entriesSelect">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2">registros</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="searchInput" 
                                   placeholder="Buscar...">
                        </div>
                    </div>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                {% for columna in columnas %}
                                    <th>{{ columna }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for fila in datos %}
                                <tr class="data-row">
                                    {% for valor in fila %}
                                        <td>
                                            {% if valor|length > 100 %}
                                                <div class="text-content">
                                                    <span class="short-text">{{ valor|slice:":100" }}...</span>
                                                    <span class="full-text" style="display: none;">{{ valor }}</span>
                                                    <button class="btn btn-link btn-sm toggle-text" type="button">
                                                        Ver más
                                                    </button>
                                                </div>
                                            {% else %}
                                                {{ valor|default_if_none:'-' }}
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            Mostrando <span id="startIndex">0</span> a <span id="endIndex">0</span> de <span id="totalItems">0</span> entradas
                        </div>
                        <div>
                            <button id="prevButton" class="btn btn-secondary">Anterior</button>
                            <button id="nextButton" class="btn btn-secondary">Siguiente</button>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    La tabla existe pero no contiene datos.
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>
<style>
.popup {
    display: none;
    background: white;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
}

.text-content {
    position: relative;
}
</style>

<script>
let currentPage = 1;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar con 5 elementos
    document.getElementById('entriesSelect').value = '5';
    updatePagination();

    // Event listeners
    document.getElementById('entriesSelect').addEventListener('change', function() {
        currentPage = 1;
        updatePagination();
    });

    document.getElementById('prevButton').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    });

    document.getElementById('nextButton').addEventListener('click', function() {
        const rows = document.querySelectorAll('.data-row');
        const rowsPerPage = parseInt(document.getElementById('entriesSelect').value);
        const maxPages = Math.ceil(rows.length / rowsPerPage);
        
        if (currentPage < maxPages) {
            currentPage++;
            updatePagination();
        }
    });
});

function updatePagination() {
    const rowsPerPage = parseInt(document.getElementById('entriesSelect').value);
    const rows = Array.from(document.querySelectorAll('.data-row'));
    const totalRows = rows.length;
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

    // Ocultar/mostrar filas según la página actual
    rows.forEach((row, index) => {
        row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
    });

    // Actualizar contadores
    document.getElementById('startIndex').textContent = totalRows ? startIndex + 1 : 0;
    document.getElementById('endIndex').textContent = endIndex;
    document.getElementById('totalItems').textContent = totalRows;

    // Actualizar estado de botones
    document.getElementById('prevButton').disabled = currentPage === 1;
    document.getElementById('nextButton').disabled = endIndex >= totalRows;
}

// Asegurarse de que los botones de paginación existan en el HTML
if (!document.getElementById('prevButton')) {
    const paginationContainer = document.createElement('div');
    paginationContainer.innerHTML = `
        <button id="prevButton" class="btn btn-secondary">Anterior</button>
        <button id="nextButton" class="btn btn-secondary">Siguiente</button>
    `;
    document.querySelector('.table').after(paginationContainer);
}

// Manejar el botón "Ver más"
document.querySelectorAll('.toggle-text').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const container = this.closest('.text-content');
        const fullText = container.querySelector('.full-text').textContent;
        
        // Cerrar todos los popups abiertos
        document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
        
        // Buscar o crear el popup
        let popup = container.querySelector('.popup');
        if (!popup) {
            popup = document.createElement('div');
            popup.className = 'popup';
            container.appendChild(popup);
        }
        
        popup.textContent = fullText;
        popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
    });
});
</script>
{% endblock %}