{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Videojuegos{% endblock %}

{% block css %}
<link href="{% static 'css/gestionVideojuegos.css' %}" rel="stylesheet">
{% endblock %}

{% block body %}
<!-- Bloque de mensajes -->
{% if messages %}
<div id="message-alert">
    {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
        <h2>Registro de Videojuegos</h2>
        <div class="card">
            <div class="card-body">
                <form action="{% url 'registrarVideojuego' %}" method="POST">{% csrf_token %}
                    <div class="form-group">
                        <input type="text" id="txtNombre" name="txtNombre" class="form-control" placeholder="Nombre" required>
                    </div>
                    <div class="form-group">
                        <input type="number" id="numPrecio" name="numPrecio" class="form-control" placeholder="Precio en CLP" required>
                    </div>
                    <div class="form-group">
                        <select id="txtConsola" name="txtConsola" class="form-control" required>
                            <option value="" disabled selected>Seleccione una consola</option>
                            {% for marca, consolas in consolas.items %}
                                <optgroup label="{{ marca }}">
                                    {% for consola in consolas %}
                                        <option value="{{ consola }}">{{ consola }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" id="numCantidad" name="numCantidad" class="form-control" placeholder="Cantidad disponible" required>
                    </div>
                    <div class="form-group">
                        <select id="selDisponibilidad" name="selDisponibilidad" class="form-control" required>
                            <option value="tienda">Disponible en Tienda</option>
                            <option value="envio">Solo Envío</option>
                            <option value="ambos">Tienda y Envío</option>
                            <option value="sin_stock">Sin Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Filtros movidos aquí -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Filtros de búsqueda</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label class="form-label">Buscar por:</label>
                    <select id="searchColumn" class="form-select">
                        <option value="nombre">Nombre</option>
                        <option value="consola">Consola</option>
                        <option value="cantidad">Cantidad</option>
                        <option value="disponibilidad">Disponibilidad</option>
                    </select>
                </div>
                <div class="form-group mb-3" id="searchInputContainer">
                    <label class="form-label">Término de búsqueda:</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
                    <!-- Nuevo select para consolas que se mostrará cuando se seleccione "consola" -->
                    <select id="searchConsola" class="form-control" style="display: none;">
                        <option value="">Todas las consolas</option>
                        {% for marca, consolas in consolas.items %}
                            <optgroup label="{{ marca }}">
                                {% for consola in consolas %}
                                    <option value="{{ consola }}">{{ consola }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Rango de Precio:</label>
                    <div class="d-flex gap-2">
                        <input type="number" id="minPrice" class="form-control" placeholder="Mínimo">
                        <input type="number" id="maxPrice" class="form-control" placeholder="Máximo">
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">Buscar</button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-12 col-md-6 col-lg-8 col-xl-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Listado de Videojuegos</h1>
            <!-- Selector de entradas a la derecha -->
            <div class="d-flex align-items-center">
                <label class="me-2">Mostrar:</label>
                <select id="entriesSelect" class="form-select" style="width: auto;">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        <div class="table-responsive py-2">
            <table class="table table-striped text-center">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Consola</th>
                        <th>Cantidad</th>
                        <th>Disponibilidad</th>
                        <th colspan="2">Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in videojuegos %}
                    <tr class="videojuego-row">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ v.nombre }}</td>
                        <td>${{ v.precio|floatformat:0|intcomma }}</td>
                        <td>{{ v.consola }}</td>
                        <td>{{ v.cantidad }}</td>
                        <td>
                            {% if v.disponibilidad == 'ambos' %}
                                Tienda y Envío
                            {% elif v.disponibilidad == 'sin_stock' %}
                                Sin Stock
                            {% elif v.disponibilidad == 'tienda' %}
                                Disponible en tienda
                            {% elif v.disponibilidad == 'envio' %}
                                Solo envío
                            {% endif %}
                        </td>
                        <td><a href="edicionVideojuego/{{ v.id }}" class="btn btn-info">Editar</a></td>
                        <td><a href="eliminacionVideojuego/{{ v.id }}" class="btn btn-danger btnEliminacion" 
                               onclick="return confirm('¿Estás seguro de que deseas eliminar este videojuego?');">Eliminar</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Controles de paginación -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    Mostrando <span id="startIndex">1</span> a <span id="endIndex">5</span> de <span id="totalItems">{{ videojuegos.count }}</span> registros
                </div>
                <div>
                    <button id="prevPage" class="btn btn-secondary me-2" disabled>&laquo; Anterior</button>
                    <button id="nextPage" class="btn btn-secondary">Siguiente &raquo;</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección del mapa -->
<div class="row mt-3" id="mapContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ubicaciones en Mapa</h5>
            </div>
            <div class="card-body">
                <div id="map" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Mover los scripts aquí, dentro del bloque body -->
<script>
// Script para los mensajes
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var messageAlert = document.getElementById('message-alert');
        if (messageAlert) {
            messageAlert.style.display = 'none';
        }
    }, 5000);
});

// Script para el límite de la lista (esto se mantiene separado del filtrado)
document.addEventListener('DOMContentLoaded', function() {
    const entriesSelect = document.getElementById('entriesSelect');
    const rows = document.querySelectorAll('.videojuego-row');
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    const startIndexSpan = document.getElementById('startIndex');
    const endIndexSpan = document.getElementById('endIndex');
    const totalItemsSpan = document.getElementById('totalItems');
    
    let currentPage = 1;
    
    function updatePagination() {
        // Obtener solo las filas que deberían ser visibles (no filtradas)
        const visibleRows = Array.from(rows).filter(row => !row.hasAttribute('data-filtered'));
        const entriesPerPage = parseInt(entriesSelect.value);
        const totalItems = visibleRows.length;
        const totalPages = Math.ceil(totalItems / entriesPerPage);
        
        // Ocultar todas las filas primero
        rows.forEach(row => row.style.display = 'none');
        
        // Mostrar solo las filas de la página actual
        visibleRows.slice(
            (currentPage - 1) * entriesPerPage,
            currentPage * entriesPerPage
        ).forEach(row => row.style.display = '');
        
        // Actualizar botones de navegación
        prevButton.disabled = currentPage <= 1;
        nextButton.disabled = currentPage >= totalPages;
        
        // Actualizar información de paginación
        const start = totalItems === 0 ? 0 : (currentPage - 1) * entriesPerPage + 1;
        const end = Math.min(start + entriesPerPage - 1, totalItems);
        startIndexSpan.textContent = start;
        endIndexSpan.textContent = end;
        totalItemsSpan.textContent = totalItems;
    }
    
    function aplicarFiltros() {
        const searchColumn = document.getElementById('searchColumn').value;
        const searchText = searchColumn === 'consola' 
            ? document.getElementById('searchConsola').value 
            : document.getElementById('searchInput').value.toLowerCase();
        const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
        const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
        
        rows.forEach(row => {
            let found = false;
            const cells = row.getElementsByTagName('td');
            const precio = parseFloat(cells[2].textContent.replace('$', '').replace(/\./g, '')) || 0;
            
            const precioEnRango = precio >= minPrice && (maxPrice === Infinity || precio <= maxPrice);
            
            Array.from(cells).forEach((cell, index) => {
                if (getColumnName(index) === searchColumn) {
                    if (searchColumn === 'consola') {
                        if (searchText === '' || cell.textContent === searchText) {
                            found = true;
                        }
                    } else {
                        if (cell.textContent.toLowerCase().includes(searchText)) {
                            found = true;
                        }
                    }
                }
            });
            
            if (searchText === '') {
                found = true;
            }
            
            // Usar data-filtered para marcar filas filtradas
            if (!(found && precioEnRango)) {
                row.setAttribute('data-filtered', '');
            } else {
                row.removeAttribute('data-filtered');
            }
        });
        
        currentPage = 1;
        updatePagination();
    }
    
    function limpiarFiltros() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchConsola').value = '';
        document.getElementById('searchColumn').value = 'nombre';
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        
        // Restaurar visibilidad de campos
        document.getElementById('searchInput').style.display = 'block';
        document.getElementById('searchConsola').style.display = 'none';
        
        // Limpiar filtros de todas las filas
        rows.forEach(row => row.removeAttribute('data-filtered'));
        
        currentPage = 1;
        updatePagination();
    }
    
    // Event Listeners
    entriesSelect.addEventListener('change', function() {
        currentPage = 1;
        updatePagination();
    });
    
    prevButton.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    });
    
    nextButton.addEventListener('click', function() {
        const visibleRows = Array.from(rows).filter(row => !row.hasAttribute('data-filtered'));
        const totalPages = Math.ceil(visibleRows.length / parseInt(entriesSelect.value));
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination();
        }
    });
    
    // Inicialización
    window.aplicarFiltros = aplicarFiltros;
    window.limpiarFiltros = limpiarFiltros;
    
    entriesSelect.value = '5';
    updatePagination();
});

document.getElementById('searchColumn').addEventListener('change', function() {
    const searchInput = document.getElementById('searchInput');
    const searchConsola = document.getElementById('searchConsola');
    
    if (this.value === 'consola') {
        searchInput.style.display = 'none';
        searchConsola.style.display = 'block';
    } else {
        searchInput.style.display = 'block';
        searchConsola.style.display = 'none';
    }
});

function getColumnName(index) {
    const columns = ['numero', 'nombre', 'precio', 'consola', 'cantidad', 'disponibilidad'];
    return columns[index];
}

document.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay coordenadas en la tabla
    const rows = document.querySelectorAll('tr');
    let hayCoordenadasEnTabla = false;
    
    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        Array.from(cells).forEach(cell => {
            // Verificar si el contenido de la celda parece ser coordenadas
            const contenido = cell.textContent.trim();
            if (contenido.includes(',') && contenido.split(',').length === 2) {
                const [lat, lng] = contenido.split(',').map(coord => parseFloat(coord.trim()));
                if (!isNaN(lat) && !isNaN(lng)) {
                    hayCoordenadasEnTabla = true;
                }
            }
        });
    });
    
    // Solo mostrar y inicializar el mapa si hay coordenadas
    const mapContainer = document.getElementById('mapContainer');
    if (!hayCoordenadasEnTabla) {
        mapContainer.style.display = 'none';
        return; // Salir si no hay coordenadas
    }
    
    // Mostrar el contenedor del mapa
    mapContainer.style.display = 'block';
    
    // Inicializar el mapa
    var map = L.map('map').setView([-36.8094955, -73.0674156], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Agregar marcadores para cada coordenada
    const markers = [];
    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        Array.from(cells).forEach(cell => {
            const contenido = cell.textContent.trim();
            if (contenido.includes(',') && contenido.split(',').length === 2) {
                const [lat, lng] = contenido.split(',').map(coord => parseFloat(coord.trim()));
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`Ubicación: ${lat}, ${lng}`);
                    markers.push(marker);
                }
            }
        });
    });
    
    // Si hay marcadores, ajustar el mapa para mostrarlos todos
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
});
</script>
{% endblock %} 